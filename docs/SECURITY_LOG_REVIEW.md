# Security Log Review Guide

## Overview

This guide provides comprehensive procedures for reviewing, analyzing, and responding to security logs generated by the SwitchAI backend security systems. All security events are logged with detailed metadata to enable effective monitoring and incident response.

## Table of Contents

- [Log Types & Sources](#log-types--sources)
- [Log Format & Structure](#log-format--structure)
- [Log Access & Location](#log-access--location)
- [Review Procedures](#review-procedures)
- [Analysis Tools & Commands](#analysis-tools--commands)
- [Response Protocols](#response-protocols)
- [Monitoring & Alerting](#monitoring--alerting)
- [Troubleshooting](#troubleshooting)

## Log Types & Sources

### üõ°Ô∏è Input Sanitization Logs

**Source:** `src/middleware/inputSanitization.ts`
**Purpose:** Records all blocked queries and security violations

**Event Types:**
- `input_sanitization_violation` - Blocked malicious input
- `prompt_injection_detected` - Prompt injection attempt
- `excessive_special_chars` - Character limit violations
- `obfuscation_detected` - Encoding/obfuscation attempts
- `sql_injection_blocked` - SQL injection patterns
- `xss_attempt_blocked` - Cross-site scripting attempts
- `command_injection_blocked` - System command injection

### üö¶ Rate Limiting Logs

**Source:** `src/middleware/rateLimiter.ts`
**Purpose:** Tracks API abuse and rate limit violations

**Event Types:**
- `rate_limit_exceeded` - User exceeded rate limits
- `burst_limit_exceeded` - Rapid-fire request blocking
- `ip_rate_limit_exceeded` - Anonymous IP rate limiting
- `suspicious_activity` - Unusual request patterns

### üßπ PII Protection Logs

**Source:** `src/utils/pii-scrubber.ts`
**Purpose:** Records detected and scrubbed PII data

**Event Types:**
- `pii_detected` - Personal information found and scrubbed
- `sensitive_data_blocked` - Sensitive information removed

### üîê Authentication & Access Logs

**Source:** `src/middleware/auth.ts`, `src/services/auth.ts`
**Purpose:** Security-related authentication events

**Event Types:**
- `auth_failure` - Failed authentication attempts
- `token_validation_failed` - Invalid JWT tokens
- `unauthorized_access` - Access to protected resources
- `suspicious_login` - Unusual login patterns

## Log Format & Structure

### Standard Log Entry

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "SECURITY_WARNING|SECURITY_ERROR|SECURITY_INFO",
  "event": "event_type",
  "ip": "192.168.1.1",
  "userId": "user-uuid-or-null",
  "endpoint": "/api/chat",
  "userAgent": "Mozilla/5.0...",
  "requestId": "req-uuid",
  "data": {
    // Event-specific data
  }
}
```

### Input Sanitization Log Example

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "SECURITY_WARNING",
  "event": "input_sanitization_violation",
  "ip": "192.168.1.100", 
  "userId": "usr_abc123",
  "endpoint": "/api/chat",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
  "requestId": "req_def456",
  "data": {
    "risk": "high",
    "confidence": 0.95,
    "violations": ["prompt_injection", "system_override"],
    "patterns": ["ignore previous instructions", "system:"],
    "inputHash": "sha256:abc123...",
    "inputLength": 127,
    "blocked": true,
    "suspiciousPatterns": 3
  }
}
```

### Rate Limiting Log Example

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "SECURITY_INFO",
  "event": "rate_limit_exceeded",
  "ip": "192.168.1.200",
  "userId": "usr_xyz789",
  "endpoint": "/api/chat",
  "data": {
    "currentCount": 55,
    "limitType": "authenticated_user",
    "windowMinutes": 60,
    "retryAfterSeconds": 1800,
    "consecutiveViolations": 1
  }
}
```

## Log Access & Location

### Development Environment

**Console Output:**
- All security logs are output to the console with color coding
- Use `pnpm dev` to see real-time logs during development

**Log Files:**
- Currently logging to console only in development
- Consider adding file logging for production

### Production Environment

**Centralized Logging:**
- Configure log aggregation service (e.g., ELK stack, Datadog, CloudWatch)
- Ensure log retention policies comply with security requirements
- Set up log shipping and storage

**Access Methods:**
```bash
# View recent security logs (if using file logging)
tail -f /var/log/switchai/security.log

# Search for specific events
grep "input_sanitization_violation" /var/log/switchai/security.log

# View logs for specific IP
grep "192.168.1.100" /var/log/switchai/security.log
```

## Review Procedures

### Daily Security Review

**1. Morning Security Check (15 minutes)**
```bash
# Check for high-severity events from last 24 hours
grep -E "SECURITY_ERROR|SECURITY_WARNING" security.log | tail -50

# Count blocked queries by type
grep "input_sanitization_violation" security.log | wc -l
grep "rate_limit_exceeded" security.log | wc -l
```

**2. Pattern Analysis**
- Look for recurring IP addresses in violations
- Identify common attack patterns
- Check for coordinated attack attempts
- Review user accounts with multiple violations

**3. False Positive Review**
- Examine blocked legitimate queries
- Adjust sanitization rules if needed
- Update whitelist patterns for known good inputs

### Weekly Security Review

**1. Trend Analysis**
- Compare security metrics week-over-week
- Identify new attack patterns or techniques
- Review rate limiting effectiveness
- Analyze geographical distribution of attacks

**2. Rule Effectiveness Review**
- Evaluate which security rules are most effective
- Identify rules with high false positive rates
- Consider rule refinements or additions

### Incident Response Review

**1. Immediate Response (< 5 minutes)**
- Identify active security incidents
- Block malicious IP addresses if needed
- Escalate critical security events

**2. Detailed Analysis (< 30 minutes)**
- Correlate related security events
- Determine attack scope and impact
- Document incident timeline

## Analysis Tools & Commands

### Log Analysis Scripts

**Count Security Events by Type:**
```bash
#!/bin/bash
# security-summary.sh
echo "Security Events Summary (Last 24 hours):"
echo "========================================"
grep $(date -d "1 day ago" '+%Y-%m-%d') security.log | \
  jq -r '.event' | sort | uniq -c | sort -nr
```

**Top Attacking IPs:**
```bash
#!/bin/bash
# top-attackers.sh
echo "Top Attacking IP Addresses:"
echo "=========================="
grep "SECURITY_WARNING\|SECURITY_ERROR" security.log | \
  jq -r '.ip' | sort | uniq -c | sort -nr | head -10
```

**Blocked Query Patterns:**
```bash
#!/bin/bash
# blocked-patterns.sh
echo "Most Common Blocked Patterns:"
echo "============================"
grep "input_sanitization_violation" security.log | \
  jq -r '.data.patterns[]' | sort | uniq -c | sort -nr | head -20
```

### Log Filtering Commands

**Filter by Risk Level:**
```bash
# High-risk events only
jq 'select(.data.risk == "high" or .data.risk == "critical")' security.log

# Medium and above
jq 'select(.data.risk == "medium" or .data.risk == "high" or .data.risk == "critical")' security.log
```

**Filter by Time Range:**
```bash
# Last hour
jq --arg start "$(date -d '1 hour ago' -Iseconds)" \
   'select(.timestamp >= $start)' security.log

# Specific date range
jq --arg start "2024-01-01T00:00:00Z" --arg end "2024-01-02T00:00:00Z" \
   'select(.timestamp >= $start and .timestamp <= $end)' security.log
```

**Filter by User/IP:**
```bash
# Specific user
jq --arg userId "usr_abc123" 'select(.userId == $userId)' security.log

# Specific IP
jq --arg ip "192.168.1.100" 'select(.ip == $ip)' security.log
```

### Security Metrics Dashboard

**Key Metrics to Track:**
- Total security events per day/hour
- Blocked queries by type and severity
- Rate limiting violations
- Top attacking IP addresses
- Most common attack patterns
- False positive rates
- Response times to incidents

**Sample Metrics Query:**
```bash
#!/bin/bash
# daily-metrics.sh
TODAY=$(date '+%Y-%m-%d')

echo "Security Metrics for $TODAY:"
echo "============================"

# Total events
TOTAL=$(grep "$TODAY" security.log | wc -l)
echo "Total Security Events: $TOTAL"

# Blocked inputs
BLOCKED=$(grep "$TODAY.*input_sanitization_violation" security.log | wc -l)
echo "Blocked Malicious Inputs: $BLOCKED"

# Rate limits
RATE_LIMITED=$(grep "$TODAY.*rate_limit_exceeded" security.log | wc -l)
echo "Rate Limit Violations: $RATE_LIMITED"

# Unique attacking IPs
UNIQUE_IPS=$(grep "$TODAY.*SECURITY_WARNING\|SECURITY_ERROR" security.log | \
  jq -r '.ip' | sort | uniq | wc -l)
echo "Unique Attacking IPs: $UNIQUE_IPS"
```

## Response Protocols

### Severity Classification

**CRITICAL (Immediate Response Required)**
- Multiple coordinated attack attempts
- Successful exploitation indicators
- Large-scale automated attacks
- System compromise indicators

**HIGH (Response within 1 hour)**
- Sophisticated prompt injection attempts
- Repeated attacks from same source
- High-confidence attack patterns
- Unusual attack vectors

**MEDIUM (Response within 4 hours)**
- Standard attack patterns
- Moderate rate limiting violations
- Common injection attempts
- Single-source attacks

**LOW (Daily review)**
- Minor violations
- Low-confidence patterns
- Rate limiting warnings
- Standard automated scans

### Response Actions

**Immediate Actions:**
1. **IP Blocking**: Block attacking IP addresses
2. **Rate Limit Adjustment**: Tighten limits for suspicious sources
3. **User Account Review**: Check compromised accounts
4. **System Status Check**: Verify system integrity

**Follow-up Actions:**
1. **Pattern Analysis**: Update detection rules
2. **Security Rule Tuning**: Adjust sensitivity
3. **Documentation**: Record incident details
4. **Team Notification**: Alert security team

### IP Blocking Procedures

**Temporary Block (Development):**
```bash
# Add to firewall rules (example)
sudo iptables -A INPUT -s 192.168.1.100 -j DROP

# Or configure application-level blocking
# Update rate limiting rules to block specific IPs
```

**Production Block:**
```bash
# Update load balancer/CDN rules
# Add to WAF (Web Application Firewall) blocklist
# Configure cloud provider security groups
```

## Monitoring & Alerting

### Real-time Monitoring

**Log Monitoring Setup:**
```bash
# Tail security logs with filtering
tail -f security.log | grep -E "SECURITY_ERROR|SECURITY_WARNING"

# Monitor specific attack types
tail -f security.log | jq 'select(.event == "input_sanitization_violation")'
```

**Alert Thresholds:**
- More than 10 blocked queries from single IP in 5 minutes
- More than 50 total security events in 1 hour
- Any CRITICAL level security events
- Rate limiting violations exceeding 100/hour

### Automated Alerting

**Email/Slack Alerts:**
```bash
#!/bin/bash
# security-alert.sh
CRITICAL_COUNT=$(grep -c "SECURITY_ERROR" security.log)
if [ $CRITICAL_COUNT -gt 0 ]; then
  # Send alert notification
  curl -X POST "$SLACK_WEBHOOK" \
    -H 'Content-type: application/json' \
    --data "{\"text\":\"üö® CRITICAL: $CRITICAL_COUNT security errors detected\"}"
fi
```

**Health Check Integration:**
- Include security metrics in health checks
- Monitor log processing pipeline
- Alert on logging failures or delays

## Troubleshooting

### Common Issues

**1. High False Positive Rate**
- **Symptoms**: Legitimate queries being blocked
- **Investigation**: Review blocked patterns and user feedback
- **Resolution**: Adjust sanitization rules, add exceptions

**2. Missing Logs**
- **Symptoms**: Expected security events not appearing
- **Investigation**: Check log configuration and middleware setup
- **Resolution**: Verify logging middleware is properly applied

**3. Log Volume Issues**
- **Symptoms**: Excessive log generation affecting performance
- **Investigation**: Analyze log patterns and frequency
- **Resolution**: Adjust log levels, implement sampling

**4. Delayed Alerts**
- **Symptoms**: Security incidents not promptly detected
- **Investigation**: Check monitoring pipeline and alert thresholds
- **Resolution**: Optimize alert configuration and processing

### Diagnostic Commands

**Check Log Configuration:**
```bash
# Verify log level configuration
grep -r "console.log\|logger" src/

# Check middleware order
grep -A 10 -B 10 "inputSanitization" src/index.ts
```

**Validate Log Format:**
```bash
# Check for malformed JSON logs
jq empty security.log 2>&1 | head -20

# Validate required fields
jq 'select(.timestamp and .level and .event)' security.log | wc -l
```

**Performance Impact:**
```bash
# Check log file sizes
du -h *.log

# Monitor logging performance
time grep "input_sanitization" security.log | wc -l
```

## Best Practices

### Log Review Best Practices

1. **Consistent Review Schedule**: Establish daily and weekly review routines
2. **Pattern Recognition**: Develop familiarity with normal vs. suspicious patterns
3. **Documentation**: Record findings and response actions
4. **Team Coordination**: Share insights with security team
5. **Continuous Improvement**: Regularly update procedures based on learnings

### Log Management Best Practices

1. **Retention Policy**: Define log retention periods based on compliance requirements
2. **Storage Security**: Protect log files from tampering
3. **Access Control**: Limit log access to authorized personnel
4. **Backup Strategy**: Ensure log backup and recovery procedures
5. **Performance Monitoring**: Monitor logging impact on system performance

### Security Response Best Practices

1. **Rapid Response**: Prioritize quick response to high-severity events
2. **Evidence Preservation**: Maintain detailed incident records
3. **Communication**: Keep stakeholders informed during incidents
4. **Post-Incident Review**: Conduct thorough post-incident analysis
5. **Process Improvement**: Update procedures based on incident learnings

## Related Documentation

- [Security Audit Procedures](SECURITY_AUDIT.md)
- [CI/CD Security Pipeline](.github/workflows/security-tests.yml)

---

**Document Version:** 1.0  
**Last Updated:** 2024-01-01  
**Next Review:** 2024-01-31 